name: ONDA News Final (08:00)

on:
  schedule:
    # 매일 아침 8시 (KST) = UTC 23:00 (전날)
    - cron: '0 23 * * *'
  workflow_dispatch:  # 수동 실행 가능

jobs:
  send-final:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Download draft info from morning workflow
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: onda-news-morning.yml
          name: draft-info
          path: .
        continue-on-error: true

      - name: Check emoji, reorder articles, regenerate HTML, and send final
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          python -c "
          import json
          import os
          from datetime import datetime, timezone, timedelta
          from slack_sender import get_starred_articles, send_final_news, generate_news_html_page

          # draft_info.json 확인
          try:
              with open('draft_info.json', 'r', encoding='utf-8') as f:
                  draft_info = json.load(f)
              print('draft_info.json 로드 성공')
          except FileNotFoundError:
              print('draft_info.json not found - 오늘 아침 발송된 기사가 없습니다')
              exit(0)

          articles = draft_info.get('articles', [])
          print(f'총 기사 수: {len(articles)}')

          # 이모지 선택 확인
          starred = get_starred_articles(
              channel_id=os.environ.get('SLACK_CHANNEL_ID'),
              bot_token=os.environ.get('SLACK_BOT_TOKEN')
          )
          print(f'선택된 기사 인덱스: {starred}')

          # 선택된 기사가 있으면 순서 재정렬
          if starred and len(starred) > 0:
              # 선택된 기사를 맨 앞으로
              selected_articles = [articles[i] for i in starred if i < len(articles)]
              remaining_indices = [i for i in range(len(articles)) if i not in starred]
              remaining_articles = [articles[i] for i in remaining_indices]
              reordered_articles = selected_articles + remaining_articles
              print(f'기사 순서 재정렬 완료: TOP {len(selected_articles)}개 에디터 선정')
          else:
              reordered_articles = articles
              print('에디터 선정 없음 - AI 자동 선정 순서 유지')

          # HTML 재생성 (news_pages 폴더에)
          kst = timezone(timedelta(hours=9))
          today = datetime.now(kst).strftime('%Y-%m-%d')

          html_path, html_filename = generate_news_html_page(reordered_articles, output_dir='news_pages')
          print(f'HTML 재생성 완료: {html_path}')

          # GitHub Pages URL
          full_news_url = f'https://jackpopup.github.io/onda-news-scraper/{today}.html'

          # 최종 Slack 발송
          result = send_final_news(
              top3_indices=starred if starred else None,
              channel_id=os.environ.get('SLACK_CHANNEL_ID'),
              bot_token=os.environ.get('SLACK_BOT_TOKEN'),
              full_news_url=full_news_url
          )

          if result['success']:
              print(f'최종 발송 성공! {result.get(\"selection_note\")}')
              print(f'TOP 3 인덱스: {result.get(\"top3_indices\")}')
          else:
              print(f'최종 발송 실패: {result.get(\"message\")}')
              exit(1)
          "

      - name: Upload updated HTML to GitHub Pages
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TODAY=$(TZ=Asia/Seoul date +%Y-%m-%d)
          HTML_FILE=$(ls -t news_pages/*.html 2>/dev/null | head -1)

          if [ -z "$HTML_FILE" ]; then
            echo "No HTML file found"
            exit 0
          fi

          echo "Uploading updated $HTML_FILE to GitHub Pages..."

          # Clone the pages repo
          git clone https://${GH_TOKEN}@github.com/jackpopup/onda-news-scraper.git /tmp/pages-repo

          # Copy updated HTML (overwrite)
          cp "$HTML_FILE" "/tmp/pages-repo/${TODAY}.html"
          cp "$HTML_FILE" "/tmp/pages-repo/index.html"

          # Commit and push
          cd /tmp/pages-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Update news with editor selection: ${TODAY}" || echo "No changes to commit"
          git push || echo "Push failed"
